<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPE Monitoring Dashboard</title>
    <!-- Load Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font and layout settings */
        :root { font-family: 'Inter', sans-serif; }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr); 
            grid-template-rows: auto auto; 
            gap: 1.5rem; 
            padding: 2rem;
            min-height: 100vh;
            background-color: #f7f9fb;
        }
        .grid-item {
            border: 1px solid #e0e7ff; 
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            min-height: 200px; 
            display: flex;
            flex-direction: column;
        }
        #video-feed-container {
            padding: 1rem;
            background-color: #1f2937;
            align-items: center;
            justify-content: center;
        }
        #live-video {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
            max-height: 400px;
            object-fit: contain;
        }
        
        #data-display {
            background-color: #1f2937;
            color: #d1fae5;
            align-items: center;
            justify-content: space-around;
        }
        .data-label {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #9ca3af;
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 700;
            transition: all 0.3s ease-in-out;
            font-size: 2rem;
        }
        .status-ok {
            background-color: #10b981;
            color: white;
        }
        .status-missing {
            background-color: #ef4444;
            color: white;
            animation: pulse-red 1s infinite;
        }
        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .timestamp {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 1rem;
        }

        /* Responsive adjustments for mobile */
        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr;
                padding: 1rem;
            }
        }
    </style>

    <script>
        // NOTE: The Python server runs on port 8000
        const API_URL = 'http://localhost:8000/status';
        
        function updateStatusDisplay(status) {
            const elements = [
                { id: 'status-hardhat', value: status.hardhat, label: 'Hardhat' },
                { id: 'status-vest', value: status.vest, label: 'Vest' },
                { id: 'status-mask', value: status.mask, label: 'Mask' },
            ];

            elements.forEach(el => {
                const target = document.getElementById(el.id);
                if (target) {
                    const isOk = el.value === 1;
                    target.textContent = isOk ? 'OK' : 'MISSING';
                    
                    // Update classes for color and animation
                    target.className = `status-badge ${isOk ? 'status-ok' : 'status-missing'}`;
                }
            });
            
            // Update Grid 4 JSON display
            const jsonHardhat = document.getElementById('json-hardhat');
            const jsonVest = document.getElementById('json-vest');
            const jsonMask = document.getElementById('json-mask');
            
            if (jsonHardhat) jsonHardhat.textContent = status.hardhat;
            if (jsonVest) jsonVest.textContent = status.vest;
            if (jsonMask) jsonMask.textContent = status.mask;
            
            // Update JSON value colors
            [jsonHardhat, jsonVest, jsonMask].forEach(el => {
                if (el) {
                    el.style.color = el.textContent === '1' ? '#10b981' : '#ef4444';
                }
            });
            
            // Update timestamp
            const tsElement = document.getElementById('last-updated');
            if (tsElement && status.timestamp) {
                const date = new Date(status.timestamp * 1000);
                tsElement.textContent = `Last updated: ${date.toLocaleTimeString()}`;
            }
        }

        async function fetchData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                updateStatusDisplay(data);
            } catch (error) {
                console.error("Could not fetch status:", error);
            }
        }

        // Fetch data every 500 milliseconds (0.5 seconds)
        window.onload = () => {
            fetchData();
            setInterval(fetchData, 500); 
        };
    </script>
</head>
<body>

    <div class="grid-container">
        
        <!-- GRID 1: Hibiscus Sense Board Information -->
        <div class="grid-item bg-gradient-to-br from-blue-50 to-indigo-100">
            <h2 class="text-xl font-bold text-indigo-800 mb-3 border-b-2 border-indigo-300 pb-2">1. Hibiscus Sense ESP32 IoT Board</h2>
            
            <div class="flex flex-col md:flex-row gap-4">
                <!-- Board Illustration -->
                <div class="flex-shrink-0 bg-white rounded-lg p-3 shadow-md">
                    <svg width="120" height="140" viewBox="0 0 120 140" xmlns="http://www.w3.org/2000/svg">
                        <!-- PCB Base -->
                        <rect x="10" y="10" width="100" height="120" rx="5" fill="#2d5016" stroke="#1a3009" stroke-width="2"/>
                        
                        <!-- ESP32 Chip -->
                        <rect x="35" y="30" width="50" height="40" rx="2" fill="#1a1a1a" stroke="#666" stroke-width="1"/>
                        <text x="60" y="52" font-size="8" fill="#00ff00" text-anchor="middle" font-family="monospace">ESP32</text>
                        
                        <!-- Sensors -->
                        <circle cx="30" cy="90" r="8" fill="#4169e1" stroke="#fff" stroke-width="1"/>
                        <text x="30" y="93" font-size="6" fill="#fff" text-anchor="middle">BME</text>
                        
                        <circle cx="60" cy="90" r="8" fill="#ff6347" stroke="#fff" stroke-width="1"/>
                        <text x="60" y="93" font-size="6" fill="#fff" text-anchor="middle">MPU</text>
                        
                        <circle cx="90" cy="90" r="8" fill="#ffa500" stroke="#fff" stroke-width="1"/>
                        <text x="90" y="93" font-size="6" fill="#fff" text-anchor="middle">RGB</text>
                        
                        <!-- GPIO Pins -->
                        <g fill="#ffd700" stroke="#000" stroke-width="0.5">
                            <rect x="5" y="15" width="3" height="30"/>
                            <rect x="5" y="50" width="3" height="30"/>
                            <rect x="5" y="85" width="3" height="30"/>
                            <rect x="112" y="15" width="3" height="30"/>
                            <rect x="112" y="50" width="3" height="30"/>
                            <rect x="112" y="85" width="3" height="30"/>
                        </g>
                        
                        <!-- USB-C Port -->
                        <rect x="45" y="125" width="30" height="8" rx="2" fill="#c0c0c0" stroke="#000" stroke-width="1"/>
                    </svg>
                </div>
                
                <!-- Specifications -->
                <div class="flex-1 space-y-2">
                    <div class="bg-white rounded-lg p-2 shadow-sm">
                        <h3 class="font-bold text-indigo-700 text-sm mb-1">Microcontroller</h3>
                        <p class="text-xs text-gray-700">Dual-core ESP32 @ 240MHz, 4MB Flash</p>
                    </div>
                    
                    <div class="bg-white rounded-lg p-2 shadow-sm">
                        <h3 class="font-bold text-indigo-700 text-sm mb-1">Connectivity</h3>
                        <p class="text-xs text-gray-700">WiFi, Bluetooth BLE, ESP-NOW</p>
                    </div>
                    
                    <div class="bg-white rounded-lg p-2 shadow-sm">
                        <h3 class="font-bold text-indigo-700 text-sm mb-1">Built-in Sensors</h3>
                        <ul class="text-xs text-gray-700 space-y-0.5">
                            <li>APDS9960: RGB, Gesture, Proximity</li>
                            <li>BME280: Temperature, Humidity, Pressure</li>
                            <li>MPU6050: Accelerometer, Gyroscope</li>
                        </ul>
                    </div>
                    
                    <div class="bg-white rounded-lg p-2 shadow-sm">
                        <h3 class="font-bold text-indigo-700 text-sm mb-1">Actuators</h3>
                        <p class="text-xs text-gray-700">RGB LED, Buzzer</p>
                    </div>
                </div>
            </div>
            
            <!-- Use Case Banner -->
            <div class="mt-3 bg-indigo-600 text-white rounded-lg p-2 text-center">
                <p class="text-xs font-semibold">Receives PPE alerts & triggers alarm/LED warnings</p>
            </div>
        </div>
        
        <!-- GRID 2: Real-Time Status Display -->
        <div id="data-display" class="grid-item">
            <h2 class="text-2xl font-bold text-gray-300 mb-6">2. Live PPE Status Report</h2>
            
            <div class="flex flex-row justify-around w-full space-x-4">
                <div class="text-center">
                    <div class="data-label">Hardhat</div>
                    <span id="status-hardhat" class="status-badge">Loading...</span>
                </div>
                
                <div class="text-center">
                    <div class="data-label">Vest</div>
                    <span id="status-vest" class="status-badge">Loading...</span>
                </div>
                
                <div class="text-center">
                    <div class="data-label">Mask</div>
                    <span id="status-mask" class="status-badge">Loading...</span>
                </div>
            </div>

            <p class="timestamp" id="last-updated">Last updated: --:--:--</p>
        </div>
        
        <!-- GRID 3: Live Video Feed -->
        <div id="video-feed-container" class="grid-item">
            <h2 class="text-xl font-bold text-gray-300 mb-3 w-full text-center">3. Live Camera Feed (YOLO Detection)</h2>
            <img id="live-video" src="http://localhost:8000/video_feed" alt="Live PPE Detection Stream">
        </div>
        
        <!-- GRID 4: ESP32 Status & Data Transmission -->
        <div class="grid-item bg-purple-50">
            <h2 class="text-xl font-bold text-purple-700 mb-3 border-b pb-2">4. Data Sent to ESP32 (Hibiscus Sense)</h2>
            <p class="text-gray-600 text-xs mb-3">Real-time JSON payload transmitted to: <code class="bg-purple-200 px-1 rounded">http://192.168.0.148/update</code></p>
            
            <div class="bg-white border-2 border-purple-300 rounded-lg p-4 font-mono text-sm">
                <div class="text-gray-500 mb-2">POST Request Body:</div>
                <pre id="esp32-data" class="text-purple-900 whitespace-pre-wrap">{
  "hardhat": <span id="json-hardhat" class="font-bold">1</span>,
  "vest": <span id="json-vest" class="font-bold">1</span>,
  "mask": <span id="json-mask" class="font-bold">1</span>
}</pre>
            </div>
            
            <div class="mt-3 text-xs text-gray-500">
                <span id="esp32-status" class="font-semibold">Connected</span> | Updates every 1.0s
            </div>
        </div>

    </div>

</body>
</html>
